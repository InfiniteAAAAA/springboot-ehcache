WITH 
-- 步骤1: 定义目标日期（上一个工作日）
target_date AS (
  SELECT 
    MAX(to_date(cob_date, 'YYYYMMDD')) AS query_date 
  FROM feed_om 
  WHERE to_date(cob_date, 'YYYYMMDD') < CURRENT_DATE
    AND EXTRACT(ISODOW FROM to_date(cob_date, 'YYYYMMDD')) < 6
),
-- 步骤2: 获取目标日期的数据
target_data AS (
  SELECT 
    f.*,
    (f.update_at - f.create_at) AS record_count
  FROM feed_om f
  JOIN target_date t ON to_date(f.cob_date, 'YYYYMMDD') = t.query_date
),
-- 步骤3: 获取过去10个工作日
past_dates AS (
  SELECT 
    cob_date,
    to_date(cob_date, 'YYYYMMDD') AS work_date
  FROM feed_om
  WHERE 
    to_date(cob_date, 'YYYYMMDD') < (SELECT query_date FROM target_date)
    AND EXTRACT(ISODOW FROM to_date(cob_date, 'YYYYMMDD')) < 6
  GROUP BY cob_date, work_date
  ORDER BY work_date DESC
  LIMIT 10
),
-- 步骤4: 计算平均耗时
avg_data AS (
  SELECT 
    f.site,
    f.data_type,
    f.data_sub_type,
    AVG(f.update_at - f.create_at)::BIGINT AS record_count_avg
  FROM feed_om f
  JOIN past_dates p ON f.cob_date = p.cob_date
  GROUP BY f.site, f.data_type, f.data_sub_type
)
-- 最终结果 - 使用更安全的计算方式
SELECT 
  t.*,
  a.record_count_avg,
  CASE 
    WHEN t.record_count >= COALESCE(a.record_count_avg, 0) 
    THEN ROUND(
           (t.record_count - COALESCE(a.record_count_avg, 0))::NUMERIC * 100.0 / 
           NULLIF(COALESCE(a.record_count_avg, 0), 0),
           2
         )
    ELSE NULL 
  END AS mvt_pct
FROM target_data t
LEFT JOIN avg_data a
  ON t.site = a.site
  AND t.data_type = a.data_type
  AND t.data_sub_type = a.data_sub_type;