WITH 
-- 步骤1: 定义目标日期（上一个工作日）
target_date AS (
  SELECT 
    MAX(cob_date) AS query_date 
  FROM feed_om 
  WHERE cob_date < CURRENT_DATE
    AND EXTRACT(ISODOW FROM cob_date) < 6  -- 确保是工作日
),
-- 步骤2: 获取目标日期的数据并计算耗时
target_data AS (
  SELECT 
    f.*,
    EXTRACT(EPOCH FROM (f.update_at - f.create_at)) * 1000 AS record_count
  FROM feed_om f
  JOIN target_date t ON f.cob_date = t.query_date
),
-- 步骤3: 获取过去10个工作日的平均耗时
avg_data AS (
  SELECT 
    f.site,
    f.data_type,
    f.data_sub_type,
    AVG(EXTRACT(EPOCH FROM (f.update_at - f.create_at)) * 1000) AS record_count_avg
  FROM feed_om f
  WHERE f.cob_date IN (
    SELECT cob_date
    FROM (
      SELECT 
        cob_date,
        ROW_NUMBER() OVER (ORDER BY cob_date DESC) AS rn
      FROM feed_om
      WHERE 
        cob_date < (SELECT query_date FROM target_date)
        AND EXTRACT(ISODOW FROM cob_date) < 6  -- 排除周末
      ORDER BY cob_date DESC
      LIMIT 10  -- 最近10个工作日
    ) past_dates
  )
  GROUP BY f.site, f.data_type, f.data_sub_type
)
-- 最终结果
SELECT 
  t.*,
  ROUND(a.record_count_avg)::BIGINT AS record_count_avg,
  CASE 
    WHEN t.record_count >= a.record_count_avg 
    THEN ROUND(
           ((t.record_count - a.record_count_avg) / a.record_count_avg * 100)::NUMERIC,
           2
         )
    ELSE NULL 
  END AS mvt_pct
FROM target_data t
LEFT JOIN avg_data a
  ON t.site = a.site
  AND t.data_type = a.data_type
  AND t.data_sub_type = a.data_sub_type;