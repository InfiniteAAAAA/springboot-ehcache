WITH 
-- 步骤1: 定义目标日期（上一个工作日）
target_date AS (
  SELECT 
    MAX(to_date(cob_date, 'YYYYMMDD')) AS query_date 
  FROM feed_om 
  WHERE to_date(cob_date, 'YYYYMMDD') < CURRENT_DATE
    AND EXTRACT(ISODOW FROM to_date(cob_date, 'YYYYMMDD')) < 6  -- 确保是工作日
),
-- 步骤2: 获取目标日期的数据并计算耗时
target_data AS (
  SELECT 
    f.*,
    (f.update_at - f.create_at) AS record_count  -- 直接相减得到时间差
  FROM feed_om f
  JOIN target_date t ON to_date(f.cob_date, 'YYYYMMDD') = t.query_date
),
-- 步骤3: 获取过去10个工作日的平均耗时 (修正ORDER BY错误)
past_dates AS (
  SELECT 
    cob_date,
    to_date(cob_date, 'YYYYMMDD') AS work_date  -- 添加转换后的日期到SELECT列表
  FROM feed_om
  WHERE 
    to_date(cob_date, 'YYYYMMDD') < (SELECT query_date FROM target_date)
    AND EXTRACT(ISODOW FROM to_date(cob_date, 'YYYYMMDD')) < 6
  GROUP BY cob_date, work_date  -- 按原始日期和转换日期分组
  ORDER BY work_date DESC  -- 现在work_date在选择列表中
  LIMIT 10
),
avg_data AS (
  SELECT 
    f.site,
    f.data_type,
    f.data_sub_type,
    AVG(f.update_at - f.create_at)::BIGINT AS record_count_avg  -- 计算平均值
  FROM feed_om f
  JOIN past_dates p ON f.cob_date = p.cob_date
  GROUP BY f.site, f.data_type, f.data_sub_type
)
-- 最终结果
SELECT 
  t.*,
  a.record_count_avg,
  CASE 
    WHEN t.record_count >= COALESCE(a.record_count_avg, 0) 
    THEN ROUND(
           ((t.record_count - COALESCE(a.record_count_avg, 0))::NUMERIC / 
           NULLIF(COALESCE(a.record_count_avg, 0), 0) * 100,
           2
         )
    ELSE NULL 
  END AS mvt_pct
FROM target_data t
LEFT JOIN avg_data a
  ON t.site = a.site
  AND t.data_type = a.data_type
  AND t.data_sub_type = a.data_sub_type;