WITH 
-- 步骤1: 定义目标日期（上一个工作日）
target_date AS (
  SELECT 
    MAX(cob_date::DATE) AS query_date 
  FROM feed_om 
  WHERE cob_date::DATE < CURRENT_DATE
    AND EXTRACT(ISODOW FROM cob_date::DATE) < 6  -- 确保是工作日
),
-- 步骤2: 获取目标日期的数据并计算耗时
target_data AS (
  SELECT 
    f.*,
    EXTRACT(EPOCH FROM (f.update_at - f.create_at)) * 1000 AS record_count
  FROM feed_om f
  JOIN target_date t ON f.cob_date::DATE = t.query_date
),
-- 步骤3: 获取过去10个工作日的平均耗时
past_dates AS (
  SELECT 
    cob_date::DATE AS work_date
  FROM feed_om
  WHERE 
    cob_date::DATE < (SELECT query_date FROM target_date)
    AND EXTRACT(ISODOW FROM cob_date::DATE) < 6
  GROUP BY work_date
  ORDER BY work_date DESC
  LIMIT 10
),
avg_data AS (
  SELECT 
    f.site,
    f.data_type,
    f.data_sub_type,
    AVG(EXTRACT(EPOCH FROM (f.update_at - f.create_at)) * 1000) AS record_count_avg
  FROM feed_om f
  JOIN past_dates p ON f.cob_date::DATE = p.work_date
  GROUP BY f.site, f.data_type, f.data_sub_type
)
-- 最终结果
SELECT 
  t.*,
  ROUND(a.record_count_avg)::BIGINT AS record_count_avg,
  CASE 
    WHEN t.record_count >= COALESCE(a.record_count_avg, 0) 
    THEN ROUND(
           ((t.record_count - COALESCE(a.record_count_avg, 0)) / 
           NULLIF(COALESCE(a.record_count_avg, 0), 0) * 100)::NUMERIC,
           2
         )
    ELSE NULL 
  END AS mvt_pct
FROM target_data t
LEFT JOIN avg_data a
  ON t.site = a.site
  AND t.data_type = a.data_type
  AND t.data_sub_type = a.data_sub_type;